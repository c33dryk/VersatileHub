version: '3.8'

# =============================================================================
# VERSATILE HUB - INFRASTRUCTURE
# =============================================================================
# Gestión centralizada de toda la infraestructura:
# - Traefik: Reverse Proxy & SSL
# - Portainer: Docker Management UI
# - Nginx: Static file server (opcional)
#
# Despliegue:
#   cd infrastructure
#   docker compose up -d
# =============================================================================

services:
  # ===========================================================================
  # TRAEFIK - Reverse Proxy & SSL Automation
  # ===========================================================================
  traefik:
    image: traefik:v2.11
    container_name: traefik
    restart: unless-stopped
    command:
      # API
      - --api.dashboard=true
      - --api.insecure=false
      
      # Providers
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.docker.network=web
      
      # Entrypoints
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      
      # HTTP -> HTTPS redirect (global)
      - --entrypoints.web.http.redirections.entryPoint.to=websecure
      - --entrypoints.web.http.redirections.entryPoint.scheme=https
      - --entrypoints.web.http.redirections.entrypoint.permanent=true
      
      # SSL/TLS - Cloudflare DNS Challenge
      - --certificatesresolvers.cloudflare.acme.email=${ACME_EMAIL:-admin@graficadosd.ar}
      - --certificatesresolvers.cloudflare.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.cloudflare.acme.dnschallenge=true
      - --certificatesresolvers.cloudflare.acme.dnschallenge.provider=cloudflare
      - --certificatesresolvers.cloudflare.acme.dnschallenge.resolvers=1.1.1.1:53,8.8.8.8:53
      
      # Let's Encrypt HTTP Challenge (alternativo)
      - --certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL:-admin@graficadosd.ar}
      - --certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme-http.json
      - --certificatesresolvers.letsencrypt.acme.httpchallenge=true
      - --certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web
      
      # Logs
      - --log.level=INFO
      - --accesslog=true
    
    ports:
      - "80:80"
      - "443:443"
      - "127.0.0.1:8080:8080"  # Dashboard (solo localhost)
    
    environment:
      # Cloudflare API (método Global API Key)
      - CF_API_EMAIL=${CLOUDFLARE_EMAIL}
      - CF_API_KEY=${CLOUDFLARE_API_KEY}
    
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./letsencrypt:/letsencrypt
      - ./traefik/config:/etc/traefik/config:ro
      - ./ssl:/ssl:ro
    
    # Dashboard NO expuesto públicamente (acceso solo vía SSH tunnel)
    # Acceso: ssh -L 8080:localhost:8080 user@server
    # Luego abrir: http://localhost:8080
    labels:
      - "traefik.enable=false"
    
    networks:
      - web

  # ===========================================================================
  # PORTAINER - Docker Management UI
  # ===========================================================================
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: unless-stopped
    command: -H unix:///var/run/docker.sock
    
    ports:
      - "127.0.0.1:9000:9000"  # UI (solo localhost)
    
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./data/portainer:/data
    
    # Portainer NO expuesto públicamente (acceso solo vía SSH tunnel)
    # Acceso: ssh -L 9000:localhost:9000 user@server
    # Luego abrir: http://localhost:9000
    labels:
      - "traefik.enable=false"
    
    networks:
      - web
    
    depends_on:
      - traefik

  # ===========================================================================
  # NGINX - Static File Server (Opcional)
  # ===========================================================================
  # nginx:
  #   image: nginx:alpine
  #   container_name: nginx-static
  #   restart: unless-stopped
  #   volumes:
  #     - ./nginx/www:/usr/share/nginx/html:ro
  #     - ./nginx/conf.d:/etc/nginx/conf.d:ro
  #   labels:
  #     - "traefik.enable=true"
  #     - "traefik.http.routers.nginx.rule=Host(`static.${BASE_DOMAIN}`)"
  #     - "traefik.http.routers.nginx.entrypoints=websecure"
  #     - "traefik.http.routers.nginx.tls=true"
  #     - "traefik.http.routers.nginx.tls.certresolver=cloudflare"
  #     - "traefik.http.services.nginx.loadbalancer.server.port=80"
  #   networks:
  #     - web
  #   depends_on:
  #     - traefik

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  web:
    external: true
    name: web
